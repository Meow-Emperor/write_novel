import{d as Q,J as T,u as H,r as d,o as K,e as O,g as a,w as o,i as s,I as _,l as S,P as W,Q as X,C as Y,h as v,f as I,j as B,S as F,R as Z,E as V,_ as ee}from"./index-CtaRNcZl.js";import{p as ae}from"./aiParse-BPsoHwOo.js";const le={class:"character-management"},te={class:"card-header"},oe=Q({__name:"CharacterManagement",setup(re){const k=T().params.id,M=H(),C=d(!1),w=d(!1),x=d(!1),i=d(!1),f=d(!1),E=d([]),g=d(),l=d({name:"",role:"",description:"",personality:"",background:"",appearance:"",relationships:""}),$={name:[{required:!0,message:"请输入角色名称",trigger:"blur"},{max:100,message:"角色名称不能超过100个字符",trigger:"blur"}]},U=async()=>{C.value=!0;try{const t=await _.get("/api/characters",{params:{novel_id:k}});E.value=t.data}catch(t){console.error("Failed to fetch characters:",t)}finally{C.value=!1}},A=()=>{f.value=!1,i.value=!0},D=t=>{f.value=!0,l.value={name:t.name,role:t.role,description:t.description,personality:t.personality,background:t.background,appearance:t.appearance,relationships:t.relationships},l.value.id=t.id,i.value=!0},R=async t=>{try{await Z.confirm("确定要删除这个角色吗？","提示",{type:"warning"}),await _.delete(`/api/characters/${t.id}`),V.success("删除成功"),U()}catch(e){e!=="cancel"&&console.error("Failed to delete character:",e)}},N=async()=>{g.value&&await g.value.validate(async t=>{if(t){w.value=!0;try{const e={...l.value};delete e.id,f.value?(await _.put(`/api/characters/${l.value.id}`,e),V.success("更新成功")):(await _.post("/api/characters",{...e,novel_id:k}),V.success("创建成功")),i.value=!1,U()}catch(e){console.error("Failed to submit:",e)}finally{w.value=!1}}})},q=async()=>{var t;try{x.value=!0,i.value||(f.value=!1,i.value=!0);const e=(l.value.role||"protagonist").toString(),b=(l.value.personality||"").toString(),n=M.config,y=((t=(await _.post("/api/ai/generate-character",{novel_id:k,character_role:e,character_traits:b||void 0,provider:n.provider,base_url:n.base_url,api_key:n.api_key,model_name:n.model_name,temperature:n.temperature})).data)==null?void 0:t.content)||"",u=ae(y);l.value.name=u.name||l.value.name||"AI角色",l.value.role=u.role||l.value.role,l.value.description=u.description||y,l.value.personality=u.personality||l.value.personality,l.value.background=u.background||l.value.background,l.value.appearance=u.appearance||l.value.appearance,l.value.relationships=u.relationships||l.value.relationships,V.success("已用 AI 生成并填入表单，请检查后保存")}catch{}finally{x.value=!1}},z=()=>{var t;(t=g.value)==null||t.resetFields(),l.value={name:"",role:"",description:"",personality:"",background:"",appearance:"",relationships:""}};return K(()=>{U()}),(t,e)=>{const b=s("el-icon"),n=s("el-button"),c=s("el-table-column"),y=s("el-table"),u=s("el-card"),m=s("el-input"),p=s("el-form-item"),h=s("el-option"),j=s("el-select"),G=s("el-form"),J=s("el-dialog"),L=X("loading");return S(),O("div",le,[a(u,null,{header:o(()=>[I("div",te,[e[11]||(e[11]=I("h2",null,"角色管理",-1)),I("div",null,[a(n,{class:"mr-8",onClick:q,loading:x.value},{default:o(()=>[a(b,null,{default:o(()=>[a(B(F))]),_:1}),e[9]||(e[9]=v(" AI 生成角色 ",-1))]),_:1},8,["loading"]),a(n,{type:"primary",onClick:A},{default:o(()=>[a(b,null,{default:o(()=>[a(B(F))]),_:1}),e[10]||(e[10]=v(" 新建角色 ",-1))]),_:1})])])]),default:o(()=>[W((S(),Y(y,{data:E.value,stripe:""},{default:o(()=>[a(c,{prop:"name",label:"角色名称",width:"150"}),a(c,{prop:"role",label:"角色类型",width:"120"}),a(c,{prop:"description",label:"简介","show-overflow-tooltip":""}),a(c,{prop:"personality",label:"性格",width:"150","show-overflow-tooltip":""}),a(c,{label:"操作",width:"200",fixed:"right"},{default:o(({row:r})=>[a(n,{size:"small",onClick:P=>D(r)},{default:o(()=>[...e[12]||(e[12]=[v("编辑",-1)])]),_:1},8,["onClick"]),a(n,{size:"small",type:"danger",onClick:P=>R(r)},{default:o(()=>[...e[13]||(e[13]=[v("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[L,C.value]])]),_:1}),a(J,{modelValue:i.value,"onUpdate:modelValue":e[8]||(e[8]=r=>i.value=r),title:f.value?"编辑角色":"新建角色",width:"700px",onClose:z},{footer:o(()=>[a(n,{onClick:e[7]||(e[7]=r=>i.value=!1)},{default:o(()=>[...e[14]||(e[14]=[v("取消",-1)])]),_:1}),a(n,{type:"primary",onClick:N,loading:w.value},{default:o(()=>[...e[15]||(e[15]=[v(" 确定 ",-1)])]),_:1},8,["loading"])]),default:o(()=>[a(G,{model:l.value,rules:$,ref_key:"formRef",ref:g,"label-width":"100px"},{default:o(()=>[a(p,{label:"角色名称",prop:"name"},{default:o(()=>[a(m,{modelValue:l.value.name,"onUpdate:modelValue":e[0]||(e[0]=r=>l.value.name=r),placeholder:"请输入角色名称"},null,8,["modelValue"])]),_:1}),a(p,{label:"角色类型",prop:"role"},{default:o(()=>[a(j,{modelValue:l.value.role,"onUpdate:modelValue":e[1]||(e[1]=r=>l.value.role=r),placeholder:"请选择角色类型",clearable:""},{default:o(()=>[a(h,{label:"主角",value:"主角"}),a(h,{label:"配角",value:"配角"}),a(h,{label:"反派",value:"反派"}),a(h,{label:"龙套",value:"龙套"})]),_:1},8,["modelValue"])]),_:1}),a(p,{label:"简介",prop:"description"},{default:o(()=>[a(m,{modelValue:l.value.description,"onUpdate:modelValue":e[2]||(e[2]=r=>l.value.description=r),type:"textarea",rows:3,placeholder:"请输入角色简介"},null,8,["modelValue"])]),_:1}),a(p,{label:"性格特点",prop:"personality"},{default:o(()=>[a(m,{modelValue:l.value.personality,"onUpdate:modelValue":e[3]||(e[3]=r=>l.value.personality=r),type:"textarea",rows:3,placeholder:"请输入角色性格特点"},null,8,["modelValue"])]),_:1}),a(p,{label:"背景故事",prop:"background"},{default:o(()=>[a(m,{modelValue:l.value.background,"onUpdate:modelValue":e[4]||(e[4]=r=>l.value.background=r),type:"textarea",rows:3,placeholder:"请输入角色背景故事"},null,8,["modelValue"])]),_:1}),a(p,{label:"外貌描述",prop:"appearance"},{default:o(()=>[a(m,{modelValue:l.value.appearance,"onUpdate:modelValue":e[5]||(e[5]=r=>l.value.appearance=r),type:"textarea",rows:3,placeholder:"请输入角色外貌描述"},null,8,["modelValue"])]),_:1}),a(p,{label:"人物关系",prop:"relationships"},{default:o(()=>[a(m,{modelValue:l.value.relationships,"onUpdate:modelValue":e[6]||(e[6]=r=>l.value.relationships=r),type:"textarea",rows:3,placeholder:"请输入与其他角色的关系"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),ie=ee(oe,[["__scopeId","data-v-e0093704"]]);export{ie as default};
