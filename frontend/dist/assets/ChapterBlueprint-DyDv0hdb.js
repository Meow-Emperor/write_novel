import{d as me,r as m,$ as ie,C as N,w as l,i as s,l as V,g as e,e as U,F as ge,t as he,f,G as A,h as u,j as D,S as oe,P as ce,Q as ve,H as G,a0 as Ve,a1 as pe,R as ne,I as B,E as w,a2 as we,T as Ce,U as ke,V as xe,a3 as Ie,X as De,_ as _e,u as $e,J as Ae,o as Te,a4 as Ee,k as Ue}from"./index-CtaRNcZl.js";import{c as Be}from"./aiParse-BPsoHwOo.js";import{A as Re}from"./AIAssistantDialog-Ckjeq38U.js";const Se={class:"card-header"},Me={key:0,class:"empty-state"},Fe={key:1,class:"version-list"},Ne={class:"version-header"},ze={class:"version-info"},Pe={class:"version-label"},Le={class:"version-meta"},Oe={key:0},Ge={class:"version-preview"},He={class:"card-header"},We={class:"actions"},je={key:0,class:"empty-state"},qe={key:1,class:"version-content"},Je={class:"content-info"},Qe={class:"content-body"},Xe={key:0,class:"version-compare"},Ke={key:0,class:"compare-view"},Ye=me({__name:"ChapterVersionManager",props:{chapterId:{},modelValue:{type:Boolean}},emits:["update:modelValue","version-changed"],setup(se,{emit:X}){const z=se,H=X,$=m(z.modelValue),M=m(!1),F=m(!1),C=m(!1),y=m(null),h=m([]),b=m(null),R=m(null);ie(()=>z.modelValue,i=>{$.value=i,i&&P()}),ie($,i=>{H("update:modelValue",i)});async function P(){var i,a;M.value=!0;try{const r=await B.get(`/api/chapter-versions/chapter/${z.chapterId}/with-versions`);y.value=r.data,h.value=r.data.versions||[],y.value.selected_version?(b.value=y.value.selected_version,R.value=y.value.selected_version.id):h.value.length>0&&(b.value=h.value[0],R.value=h.value[0].id)}catch(r){w.error(((a=(i=r.response)==null?void 0:i.data)==null?void 0:a.detail)||"加载版本列表失败")}finally{M.value=!1}}function W(i){b.value=i,R.value=i.id}async function L(i){var a,r;try{await ne.confirm("确定要切换到此版本吗？","确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await B.post(`/api/chapter-versions/chapter/${z.chapterId}/select/${i}`),w.success("版本已切换"),P(),H("version-changed")}catch(k){k!=="cancel"&&w.error(((r=(a=k.response)==null?void 0:a.data)==null?void 0:r.detail)||"切换版本失败")}}async function c(){F.value=!0;try{w.info("此功能需要与 AI 生成集成")}finally{F.value=!1}}async function S(i,a){var r,k;if(i==="use")await L(a.id);else if(i==="delete")try{await ne.confirm("确定要删除此版本吗？此操作不可恢复。","警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}),await B.delete(`/api/chapter-versions/${a.id}`),w.success("版本已删除"),P(),H("version-changed")}catch(x){x!=="cancel"&&w.error(((k=(r=x.response)==null?void 0:r.data)==null?void 0:k.detail)||"删除版本失败")}}function j(i){return i.slice(0,100)+(i.length>100?"...":"")}function g(i){const a=new Date(i),k=new Date().getTime()-a.getTime(),x=Math.floor(k/(1e3*60*60*24));return x===0?"今天":x===1?"昨天":x<7?`${x}天前`:a.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}return(i,a)=>{const r=s("el-icon"),k=s("el-button"),x=s("el-empty"),K=s("el-tag"),J=s("el-dropdown-item"),Y=s("el-dropdown-menu"),Z=s("el-dropdown"),q=s("el-card"),ee=s("el-scrollbar"),O=s("el-col"),o=s("el-descriptions-item"),t=s("el-descriptions"),v=s("el-divider"),d=s("el-input"),_=s("el-row"),te=s("el-dialog"),le=ve("loading");return V(),N(te,{modelValue:$.value,"onUpdate:modelValue":a[4]||(a[4]=p=>$.value=p),title:"版本管理",width:"90%","close-on-click-modal":!1,"destroy-on-close":""},{default:l(()=>[e(_,{gutter:20},{default:l(()=>[e(O,{span:8},{default:l(()=>[e(q,{shadow:"never"},{header:l(()=>[f("div",Se,[f("span",null,"历史版本 ("+A(h.value.length)+")",1),e(k,{type:"primary",size:"small",onClick:c,loading:F.value},{default:l(()=>[e(r,null,{default:l(()=>[e(D(oe))]),_:1}),a[5]||(a[5]=u(" 新建版本 ",-1))]),_:1},8,["loading"])])]),default:l(()=>[e(ee,{height:"500px"},{default:l(()=>[h.value.length===0?(V(),U("div",Me,[e(x,{description:"暂无版本记录"})])):(V(),U("div",Fe,[(V(!0),U(ge,null,he(h.value,p=>{var T;return V(),N(q,{key:p.id,class:we(["version-item",{active:p.id===R.value,current:p.id===((T=y.value)==null?void 0:T.selected_version_id)}]),shadow:"hover",onClick:I=>W(p)},{default:l(()=>{var I;return[f("div",Ne,[f("div",ze,[p.id===((I=y.value)==null?void 0:I.selected_version_id)?(V(),N(K,{key:0,type:"success",size:"small"},{default:l(()=>[...a[6]||(a[6]=[u(" 当前版本 ",-1)])]),_:1})):G("",!0),f("span",Pe,A(p.version_label||`版本 #${p.id}`),1)]),e(Z,{onCommand:E=>S(E,p),trigger:"click",onClick:a[0]||(a[0]=Ce(()=>{},["stop"]))},{dropdown:l(()=>[e(Y,null,{default:l(()=>{var E;return[p.id!==((E=y.value)==null?void 0:E.selected_version_id)?(V(),N(J,{key:0,command:"use"},{default:l(()=>[e(r,null,{default:l(()=>[e(D(pe))]),_:1}),a[7]||(a[7]=u(" 设为当前版本 ",-1))]),_:1})):G("",!0),e(J,{command:"delete",divided:""},{default:l(()=>[e(r,null,{default:l(()=>[e(D(xe))]),_:1}),a[8]||(a[8]=u(" 删除 ",-1))]),_:1})]}),_:2},1024)]),default:l(()=>[e(r,{class:"more-icon"},{default:l(()=>[e(D(ke))]),_:1})]),_:2},1032,["onCommand"])]),f("div",Le,[p.provider?(V(),U("span",Oe,[e(r,null,{default:l(()=>[e(D(Ie))]),_:1}),u(" "+A(p.provider),1)])):G("",!0),f("span",null,[e(r,null,{default:l(()=>[e(D(De))]),_:1}),u(" "+A(g(p.created_at)),1)])]),f("div",Ge,A(j(p.content)),1)]}),_:2},1032,["class","onClick"])}),128))]))]),_:1})]),_:1})]),_:1}),e(O,{span:16},{default:l(()=>[ce((V(),N(q,{shadow:"never"},{header:l(()=>{var p;return[f("div",He,[a[10]||(a[10]=f("span",null,"版本内容",-1)),f("div",We,[b.value&&b.value.id!==((p=y.value)==null?void 0:p.selected_version_id)?(V(),N(k,{key:0,type:"primary",size:"small",onClick:a[1]||(a[1]=T=>L(b.value.id))},{default:l(()=>[e(r,null,{default:l(()=>[e(D(pe))]),_:1}),a[9]||(a[9]=u(" 设为当前版本 ",-1))]),_:1})):G("",!0)])])]}),default:l(()=>{var p;return[b.value?(V(),U("div",qe,[f("div",Je,[e(t,{column:2,border:""},{default:l(()=>[e(o,{label:"版本标签"},{default:l(()=>[u(A(b.value.version_label||"无"),1)]),_:1}),e(o,{label:"生成模型"},{default:l(()=>[u(A(b.value.provider||"手动创建"),1)]),_:1}),e(o,{label:"创建时间"},{default:l(()=>[u(A(new Date(b.value.created_at).toLocaleString("zh-CN")),1)]),_:1}),e(o,{label:"字数"},{default:l(()=>[u(A(b.value.content.replace(/\s/g,"").length),1)]),_:1})]),_:1})]),e(v),f("div",Qe,[e(d,{type:"textarea",modelValue:b.value.content,"onUpdate:modelValue":a[2]||(a[2]=T=>b.value.content=T),rows:15,readonly:""},null,8,["modelValue"])]),e(v,null,{default:l(()=>[...a[11]||(a[11]=[u("版本对比",-1)])]),_:1}),(p=y.value)!=null&&p.selected_version?(V(),U("div",Xe,[e(k,{onClick:a[3]||(a[3]=T=>C.value=!C.value),plain:""},{default:l(()=>[e(r,null,{default:l(()=>[e(D(Ve))]),_:1}),u(" "+A(C.value?"隐藏对比":"与当前版本对比"),1)]),_:1}),C.value?(V(),U("div",Ke,[e(_,{gutter:20},{default:l(()=>[e(O,{span:12},{default:l(()=>[a[12]||(a[12]=f("div",{class:"compare-label"},"当前版本",-1)),e(d,{type:"textarea","model-value":y.value.selected_version.content,rows:10,readonly:""},null,8,["model-value"])]),_:1}),e(O,{span:12},{default:l(()=>[a[13]||(a[13]=f("div",{class:"compare-label"},"选中版本",-1)),e(d,{type:"textarea","model-value":b.value.content,rows:10,readonly:""},null,8,["model-value"])]),_:1})]),_:1})])):G("",!0)])):G("",!0)])):(V(),U("div",je,[e(x,{description:"请从左侧选择一个版本查看详情"})]))]}),_:1})),[[le,M.value]])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}}),Ze=_e(Ye,[["__scopeId","data-v-35b7ad89"]]),et={class:"chapter-blueprint"},tt={class:"card-header"},lt=me({__name:"ChapterBlueprint",setup(se){const X=$e(),z=Ae(),H=Ue(),$=z.params.id,M=m(!1),F=m(!1),C=m(!1),y=m(!1),h=m([]),b=m(""),R=m(!1),P=m(0),W=m(!1),L=m(),c=m({title:"",chapter_number:1,summary:"",status:"DRAFT",notes:""}),S=m(!1),j=m(!1),g=m({chapter_number:1,chapter_theme:"",mode:"preview"});function i(o){return{DRAFT:"info",IN_PROGRESS:"warning",COMPLETED:"success",PUBLISHED:"success"}[o]||"info"}function a(o){return{DRAFT:"草稿",IN_PROGRESS:"进行中",COMPLETED:"已完成",PUBLISHED:"已发布"}[o]||o}async function r(){var o,t;M.value=!0;try{const v=await B.get("/api/chapters/",{params:{novel_id:$}});h.value=(v.data||[]).sort((d,_)=>d.chapter_number-_.chapter_number)}catch(v){w.error(((t=(o=v.response)==null?void 0:o.data)==null?void 0:t.detail)||"获取章节列表失败")}finally{M.value=!1}}function k(){y.value=!1;const o=h.value.length>0?Math.max(...h.value.map(t=>t.chapter_number))+1:1;c.value={title:"",chapter_number:o,summary:"",status:"DRAFT",notes:""},C.value=!0}function x(o){y.value=!0,b.value=o.id,c.value={title:o.title,chapter_number:o.chapter_number,summary:o.summary||"",status:o.status,notes:o.notes||""},C.value=!0}function K(o){H.push({name:"ContentEditor",params:{id:$,chapterId:o.id}})}function J(o){P.value=parseInt(o.id),R.value=!0}async function Y(o){var t,v;try{await ne.confirm("确定要删除这个章节吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await B.delete(`/api/chapters/${o.id}`),w.success("删除成功"),r()}catch(d){d!=="cancel"&&w.error(((v=(t=d.response)==null?void 0:t.data)==null?void 0:v.detail)||"删除失败")}}async function Z(){L.value&&await L.value.validate(async o=>{var t,v;if(o){F.value=!0;try{y.value?(await B.put(`/api/chapters/${b.value}`,c.value),w.success("更新成功")):(await B.post("/api/chapters/",{...c.value,novel_id:$,word_count:0}),w.success("创建成功")),C.value=!1,r()}catch(d){w.error(((v=(t=d.response)==null?void 0:t.data)==null?void 0:v.detail)||"提交失败")}finally{F.value=!1}}})}function q(){const o=h.value.length>0?Math.max(...h.value.map(t=>t.chapter_number))+1:1;g.value={chapter_number:o,chapter_theme:"",mode:"preview"},S.value=!0}async function ee(){var o;try{j.value=!0;const t=X.config,d=((o=(await B.post("/api/ai/generate-chapter-outline",{novel_id:$,chapter_number:g.value.chapter_number,chapter_theme:g.value.chapter_theme||void 0,provider:t.provider,base_url:t.base_url,api_key:t.api_key,model_name:t.model_name,temperature:t.temperature})).data)==null?void 0:o.content)||"",_=Be(d);g.value.mode==="auto"?(await B.post("/api/chapters/",{novel_id:$,title:_.title||`第${g.value.chapter_number}章`,chapter_number:g.value.chapter_number,summary:_.summary||d,notes:_.keyEvents||"",status:"DRAFT",word_count:0}),w.success("AI 已生成并创建章节"),S.value=!1,r()):(y.value=!1,c.value={title:_.title||`第${g.value.chapter_number}章`,chapter_number:g.value.chapter_number,summary:_.summary||d,status:"DRAFT",notes:_.keyEvents||""},S.value=!1,C.value=!0,w.success("AI 已生成内容，已填入表单供编辑"))}catch{}finally{j.value=!1}}function O(o){const t=h.value.length>0?Math.max(...h.value.map(v=>v.chapter_number))+1:1;y.value=!1,c.value={title:`第${t}章`,chapter_number:t,summary:o,status:"DRAFT",notes:""},C.value=!0,w.success("AI 助手内容已应用到新章节")}return Te(()=>{r()}),(o,t)=>{const v=s("el-icon"),d=s("el-button"),_=s("el-table-column"),te=s("el-tag"),le=s("el-table"),p=s("el-card"),T=s("el-input-number"),I=s("el-form-item"),E=s("el-input"),Q=s("el-option"),fe=s("el-select"),ue=s("el-form"),re=s("el-dialog"),de=s("el-radio"),ye=s("el-radio-group"),be=ve("loading");return V(),U("div",et,[e(p,null,{header:l(()=>[f("div",tt,[t[18]||(t[18]=f("h2",null,"章节蓝图",-1)),f("div",null,[e(d,{class:"mr-8",type:"success",onClick:t[0]||(t[0]=n=>W.value=!0)},{default:l(()=>[e(v,null,{default:l(()=>[e(D(Ee))]),_:1}),t[15]||(t[15]=u(" AI 创作助手 ",-1))]),_:1}),e(d,{class:"mr-8",onClick:q},{default:l(()=>[e(v,null,{default:l(()=>[e(D(oe))]),_:1}),t[16]||(t[16]=u(" AI 生成章节大纲 ",-1))]),_:1}),e(d,{type:"primary",onClick:k},{default:l(()=>[e(v,null,{default:l(()=>[e(D(oe))]),_:1}),t[17]||(t[17]=u(" 新建章节 ",-1))]),_:1})])])]),default:l(()=>[ce((V(),N(le,{data:h.value,stripe:""},{default:l(()=>[e(_,{prop:"chapter_number",label:"章节号",width:"100",sortable:""}),e(_,{prop:"title",label:"章节标题",width:"260"}),e(_,{prop:"summary",label:"章节概要","show-overflow-tooltip":""}),e(_,{prop:"word_count",label:"字数",width:"100"}),e(_,{prop:"status",label:"状态",width:"120"},{default:l(({row:n})=>[e(te,{type:i(n.status)},{default:l(()=>[u(A(a(n.status)),1)]),_:2},1032,["type"])]),_:1}),e(_,{label:"操作",width:"320",fixed:"right"},{default:l(({row:n})=>[e(d,{size:"small",onClick:ae=>x(n)},{default:l(()=>[...t[19]||(t[19]=[u("编辑",-1)])]),_:1},8,["onClick"]),e(d,{size:"small",type:"primary",onClick:ae=>K(n)},{default:l(()=>[...t[20]||(t[20]=[u("写作",-1)])]),_:1},8,["onClick"]),e(d,{size:"small",onClick:ae=>J(n)},{default:l(()=>[...t[21]||(t[21]=[u("版本",-1)])]),_:1},8,["onClick"]),e(d,{size:"small",type:"danger",onClick:ae=>Y(n)},{default:l(()=>[...t[22]||(t[22]=[u("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[be,M.value]])]),_:1}),e(re,{modelValue:C.value,"onUpdate:modelValue":t[7]||(t[7]=n=>C.value=n),title:y.value?"编辑章节":"新建章节",width:"720px",onClose:o.resetForm},{footer:l(()=>[e(d,{onClick:t[6]||(t[6]=n=>C.value=!1)},{default:l(()=>[...t[23]||(t[23]=[u("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:Z,loading:F.value},{default:l(()=>[...t[24]||(t[24]=[u("提交",-1)])]),_:1},8,["loading"])]),default:l(()=>[e(ue,{model:c.value,ref_key:"formRef",ref:L,"label-width":"100px"},{default:l(()=>[e(I,{label:"章节号",prop:"chapter_number"},{default:l(()=>[e(T,{modelValue:c.value.chapter_number,"onUpdate:modelValue":t[1]||(t[1]=n=>c.value.chapter_number=n),min:1,step:1},null,8,["modelValue"])]),_:1}),e(I,{label:"章节标题",prop:"title"},{default:l(()=>[e(E,{modelValue:c.value.title,"onUpdate:modelValue":t[2]||(t[2]=n=>c.value.title=n),placeholder:"请输入章节标题"},null,8,["modelValue"])]),_:1}),e(I,{label:"章节概要",prop:"summary"},{default:l(()=>[e(E,{modelValue:c.value.summary,"onUpdate:modelValue":t[3]||(t[3]=n=>c.value.summary=n),type:"textarea",rows:4,placeholder:"请输入章节概要"},null,8,["modelValue"])]),_:1}),e(I,{label:"状态",prop:"status"},{default:l(()=>[e(fe,{modelValue:c.value.status,"onUpdate:modelValue":t[4]||(t[4]=n=>c.value.status=n),placeholder:"请选择状态"},{default:l(()=>[e(Q,{label:"草稿",value:"draft"}),e(Q,{label:"进行中",value:"in_progress"}),e(Q,{label:"已完成",value:"completed"}),e(Q,{label:"已发布",value:"published"})]),_:1},8,["modelValue"])]),_:1}),e(I,{label:"备注",prop:"notes"},{default:l(()=>[e(E,{modelValue:c.value.notes,"onUpdate:modelValue":t[5]||(t[5]=n=>c.value.notes=n),type:"textarea",rows:3,placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title","onClose"]),e(re,{modelValue:S.value,"onUpdate:modelValue":t[12]||(t[12]=n=>S.value=n),title:"AI 生成章节大纲",width:"520px"},{footer:l(()=>[e(d,{onClick:t[11]||(t[11]=n=>S.value=!1)},{default:l(()=>[...t[27]||(t[27]=[u("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:ee,loading:j.value},{default:l(()=>[...t[28]||(t[28]=[u("生成",-1)])]),_:1},8,["loading"])]),default:l(()=>[e(ue,{model:g.value,"label-width":"100px"},{default:l(()=>[e(I,{label:"章节序号"},{default:l(()=>[e(T,{modelValue:g.value.chapter_number,"onUpdate:modelValue":t[8]||(t[8]=n=>g.value.chapter_number=n),min:1,step:1},null,8,["modelValue"])]),_:1}),e(I,{label:"章节主题"},{default:l(()=>[e(E,{modelValue:g.value.chapter_theme,"onUpdate:modelValue":t[9]||(t[9]=n=>g.value.chapter_theme=n),placeholder:"可选：该章主题或侧重点"},null,8,["modelValue"])]),_:1}),e(I,{label:"保存方式"},{default:l(()=>[e(ye,{modelValue:g.value.mode,"onUpdate:modelValue":t[10]||(t[10]=n=>g.value.mode=n)},{default:l(()=>[e(de,{label:"preview"},{default:l(()=>[...t[25]||(t[25]=[u("预览并编辑",-1)])]),_:1}),e(de,{label:"auto"},{default:l(()=>[...t[26]||(t[26]=[u("直接创建",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(Ze,{modelValue:R.value,"onUpdate:modelValue":t[13]||(t[13]=n=>R.value=n),"chapter-id":P.value,onVersionChanged:r},null,8,["modelValue","chapter-id"]),e(Re,{modelValue:W.value,"onUpdate:modelValue":t[14]||(t[14]=n=>W.value=n),"novel-id":D($),onContentGenerated:O},null,8,["modelValue","novel-id"])])}}}),st=_e(lt,[["__scopeId","data-v-beaa6406"]]);export{st as default};
