import{d as Z,u as K,J as X,r as _,Y as ee,o as te,$ as ae,a6 as ne,e as le,P as se,Q as oe,C as re,w as l,i as v,I,E as w,k as ie,l as F,f as g,g as a,h as d,j as L,Z as ue,G as h,a7 as de,_ as pe}from"./index-CtaRNcZl.js";const ce={class:"content-editor"},ve={class:"card-header"},fe={class:"header-left"},me={class:"header-right"},_e={class:"word-count"},ge={class:"editor-container"},ye={class:"editor-toolbar"},we={class:"editor-footer"},Ce=Z({__name:"ContentEditor",setup(Se){const E=X(),R=ie(),M=K(),C=E.params.id;let y=E.params.chapterId;const T=_(!1),b=_(!1),f=_(null),r=_(""),S=_("DRAFT"),x=_(""),V=_(),D=ee(()=>r.value.replace(/\s/g,"").length),O=n=>({DRAFT:"info",IN_PROGRESS:"warning",COMPLETED:"success",PUBLISHED:"success"})[n]||"info",G=n=>({DRAFT:"草稿",IN_PROGRESS:"进行中",COMPLETED:"已完成",PUBLISHED:"已发布"})[n]||n;async function k(){var n,e;T.value=!0;try{if(!y){await H();return}const t=await I.get(`/api/chapters/${y}`);f.value=t.data,S.value=t.data.status,x.value=t.data.notes||"",r.value=t.data.content||""}catch(t){w.error(((e=(n=t.response)==null?void 0:n.data)==null?void 0:e.detail)||"加载章节失败")}finally{T.value=!1}}async function H(){var n,e,t;try{const s=await I.get("/api/chapters",{params:{novel_id:C}}),c=Array.isArray(s.data)?s.data:[];if(c.length>0){const p=c[0].id;await R.replace({name:"ContentEditor",params:{id:C,chapterId:String(p)}}),y=String(p),await k();return}const i=(n=(await I.post("/api/chapters/",{novel_id:C,title:"第一章",chapter_number:1,summary:"",status:"DRAFT",word_count:0})).data)==null?void 0:n.id;i?(await R.replace({name:"ContentEditor",params:{id:C,chapterId:String(i)}}),y=String(i),await k()):w.error("无法创建初始章节")}catch(s){w.error(((t=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:t.detail)||(s==null?void 0:s.message)||"初始化章节失败")}}async function B(){var n,e;b.value=!0;try{await I.put(`/api/chapters/${y}`,{content:r.value,word_count:D.value,status:S.value,notes:x.value}),w.success("保存成功"),f.value&&(f.value.content=r.value,f.value.word_count=D.value,f.value.status=S.value,f.value.notes=x.value)}catch(t){w.error(((e=(n=t.response)==null?void 0:n.data)==null?void 0:e.detail)||"保存失败")}finally{b.value=!1}}function m(n,e){var p;const t=(p=V.value)==null?void 0:p.textarea;if(!t)return;const s=t.selectionStart,c=t.selectionEnd,u=r.value.substring(s,c),i=n+u+e;r.value=r.value.substring(0,s)+i+r.value.substring(c),setTimeout(()=>{t.focus(),t.setSelectionRange(s+n.length+u.length,s+n.length+u.length)},0)}function j(){}function q(){R.push({name:"ChapterBlueprint",params:{id:C}})}const $=_(!1);async function J(){var c,u;const n=(c=V.value)==null?void 0:c.textarea;if(!n)return;const e=n.selectionStart,t=n.selectionEnd,s=r.value.substring(e,t).trim();if(!s){w.info("请选择需要扩写的文本");return}try{$.value=!0;const i=M.config,A=((u=(await I.post("/api/ai/expand-content",{novel_id:C,chapter_id:y,content_snippet:s,expansion_style:"detailed",provider:i.provider,base_url:i.base_url,api_key:i.api_key,model_name:i.model_name,temperature:i.temperature})).data)==null?void 0:u.content)||"";r.value=r.value.substring(0,e)+A+r.value.substring(t),w.success("已用 AI 扩写所选文本")}catch{}finally{$.value=!1}}let z=null;return te(()=>{k(),z=window.setInterval(()=>{r.value&&!b.value&&B()},12e4)}),ae(()=>E.params.chapterId,n=>{y=n,k()}),ne(()=>{z&&clearInterval(z)}),(n,e)=>{const t=v("el-button"),s=v("el-tag"),c=v("el-icon"),u=v("el-button-group"),i=v("el-input"),p=v("el-option"),A=v("el-select"),P=v("el-form-item"),Q=v("el-form"),W=v("el-card"),Y=oe("loading");return F(),le("div",ce,[se((F(),re(W,null,{header:l(()=>{var o,U;return[g("div",ve,[g("div",fe,[a(t,{onClick:q,icon:L(ue)},{default:l(()=>[...e[11]||(e[11]=[d("返回",-1)])]),_:1},8,["icon"]),g("h2",null,h(((o=f.value)==null?void 0:o.title)||"章节编辑"),1)]),g("div",me,[a(s,{type:O(((U=f.value)==null?void 0:U.status)||"draft")},{default:l(()=>{var N;return[d(h(G(((N=f.value)==null?void 0:N.status)||"draft")),1)]}),_:1},8,["type"]),g("span",_e,"字数: "+h(D.value),1),a(t,{type:"primary",onClick:B,loading:b.value},{default:l(()=>[a(c,null,{default:l(()=>[a(L(de))]),_:1}),e[12]||(e[12]=d(" 保存 ",-1))]),_:1},8,["loading"])])])]}),default:l(()=>[g("div",ge,[g("div",ye,[a(u,null,{default:l(()=>[a(t,{size:"small",onClick:e[0]||(e[0]=o=>m("**","**"))},{default:l(()=>[...e[13]||(e[13]=[d("加粗",-1)])]),_:1}),a(t,{size:"small",onClick:e[1]||(e[1]=o=>m("*","*"))},{default:l(()=>[...e[14]||(e[14]=[d("斜体",-1)])]),_:1}),a(t,{size:"small",onClick:e[2]||(e[2]=o=>m("~~","~~"))},{default:l(()=>[...e[15]||(e[15]=[d("删除线",-1)])]),_:1})]),_:1}),a(u,{class:"ml-10"},{default:l(()=>[a(t,{size:"small",onClick:e[3]||(e[3]=o=>m(`
# `,""))},{default:l(()=>[...e[16]||(e[16]=[d("标题1",-1)])]),_:1}),a(t,{size:"small",onClick:e[4]||(e[4]=o=>m(`
## `,""))},{default:l(()=>[...e[17]||(e[17]=[d("标题2",-1)])]),_:1}),a(t,{size:"small",onClick:e[5]||(e[5]=o=>m(`
### `,""))},{default:l(()=>[...e[18]||(e[18]=[d("标题3",-1)])]),_:1})]),_:1}),a(u,{class:"ml-10"},{default:l(()=>[a(t,{size:"small",onClick:e[6]||(e[6]=o=>m(`
- `,""))},{default:l(()=>[...e[19]||(e[19]=[d("列表",-1)])]),_:1}),a(t,{size:"small",onClick:e[7]||(e[7]=o=>m(`
> `,""))},{default:l(()=>[...e[20]||(e[20]=[d("引用",-1)])]),_:1})]),_:1}),a(u,{class:"ml-10"},{default:l(()=>[a(t,{size:"small",type:"primary",onClick:J,loading:$.value},{default:l(()=>[...e[21]||(e[21]=[d("AI 扩写选中内容",-1)])]),_:1},8,["loading"])]),_:1})]),a(i,{ref_key:"editorRef",ref:V,modelValue:r.value,"onUpdate:modelValue":e[8]||(e[8]=o=>r.value=o),type:"textarea",rows:25,placeholder:"开始写作...",class:"content-textarea",onInput:j},null,8,["modelValue"]),g("div",we,[a(Q,{inline:!0,size:"small"},{default:l(()=>[a(P,{label:"状态"},{default:l(()=>[a(A,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=o=>S.value=o),style:{width:"120px"}},{default:l(()=>[a(p,{label:"草稿",value:"draft"}),a(p,{label:"进行中",value:"in_progress"}),a(p,{label:"已完成",value:"completed"}),a(p,{label:"已发布",value:"published"})]),_:1},8,["modelValue"])]),_:1}),a(P,{label:"备注"},{default:l(()=>[a(i,{modelValue:x.value,"onUpdate:modelValue":e[10]||(e[10]=o=>x.value=o),placeholder:"章节备注",style:{width:"300px"}},null,8,["modelValue"])]),_:1})]),_:1})])])]),_:1})),[[Y,T.value]])])}}}),Ie=pe(Ce,[["__scopeId","data-v-2216ecf0"]]);export{Ie as default};
