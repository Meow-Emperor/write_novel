import{d as ee,u as le,J as ae,r as i,o as te,e as r,P as oe,g as l,Q as se,C as c,w as a,i as v,I as V,l as t,F as D,t as W,h as f,f as N,H as ue,j as z,S as T,E as O,G as J,_ as re}from"./index-CtaRNcZl.js";import{b as ne}from"./aiParse-BPsoHwOo.js";const ie={class:"world-settings"},de={class:"card-header"},ce={key:0,class:"world-content"},ve={key:0},fe={key:0},pe={key:0},me={key:0},_e={key:0},ye={key:0},ge=ee({__name:"WorldSettings",setup(ke){const $=ae(),R=le(),E=$.params.id,F=i(!1),_=i(!1),p=i(!1),n=i(null),G=i(),o=i({era:"",locations:{},rules:{},culture:{}}),h=i(""),x=i(""),C=i(""),j=i(!1),U=i(!1),I=i({focus:"overall"});async function B(){var s;F.value=!0;try{const e=await V.get(`/api/worlds/novel/${E}`);n.value=e.data,o.value={era:e.data.era||"",locations:e.data.locations||{},rules:e.data.rules||{},culture:e.data.culture||{}}}catch(e){((s=e.response)==null?void 0:s.status)!==404&&console.error("Failed to fetch world setting:",e)}finally{F.value=!1}}async function M(){_.value=!0;try{const s=await V.post("/api/worlds",{novel_id:E,era:"",locations:{},rules:{},culture:{}});n.value=s.data,o.value={era:"",locations:{},rules:{},culture:{}},O.success("创建成功"),p.value=!0}catch(s){console.error("Failed to create world setting:",s)}finally{_.value=!1}}function q(){p.value=!0,h.value=JSON.stringify(o.value.locations||{},null,2),x.value=JSON.stringify(o.value.rules||{},null,2),C.value=JSON.stringify(o.value.culture||{},null,2)}function H(){p.value=!1,n.value&&(o.value={era:n.value.era||"",locations:n.value.locations||{},rules:n.value.rules||{},culture:n.value.culture||{}})}async function L(){_.value=!0;try{let s={},e={},w={};try{s=h.value?JSON.parse(h.value):{}}catch{O.error("地点设定JSON格式错误"),_.value=!1;return}try{e=x.value?JSON.parse(x.value):{}}catch{O.error("世界规则JSON格式错误"),_.value=!1;return}try{w=C.value?JSON.parse(C.value):{}}catch{O.error("文化设定JSON格式错误"),_.value=!1;return}await V.put(`/api/worlds/${n.value.id}`,{era:o.value.era,locations:s,rules:e,culture:w}),O.success("保存成功"),p.value=!1,B()}catch(s){console.error("Failed to save world setting:",s)}finally{_.value=!1}}function P(){I.value={focus:"overall"},j.value=!0}function Q(s){const e=s.match(/```json([\s\S]*?)```/i);if(e&&e[1])try{return JSON.parse(e[1])}catch{}try{return JSON.parse(s)}catch{}return null}async function K(){var s;try{U.value=!0;const e=R.config,d=((s=(await V.post("/api/ai/generate-world",{novel_id:E,focus:I.value.focus,provider:e.provider,base_url:e.base_url,api_key:e.api_key,model_name:e.model_name,temperature:e.temperature})).data)==null?void 0:s.content)||"";if(!n.value){const k=await V.post("/api/worlds",{novel_id:E,era:"",locations:{},rules:{},culture:{}});n.value=k.data}const m=Q(d)||ne(d),y=m.era||o.value.era||"",S=m.locations||o.value.locations||{},b=m.rules||o.value.rules||{},A=m.culture||o.value.culture||{};await V.put(`/api/worlds/${n.value.id}`,{era:y,locations:S,rules:b,culture:A}),O.success("AI 已生成并填充世界观"),j.value=!1,B()}catch{}finally{U.value=!1}}return te(()=>{B()}),(s,e)=>{const w=v("el-icon"),d=v("el-button"),m=v("el-input"),y=v("el-form-item"),S=v("el-empty"),b=v("el-card"),A=v("el-form"),k=v("el-option"),X=v("el-select"),Y=v("el-dialog"),Z=se("loading");return t(),r("div",ie,[oe((t(),c(b,null,{header:a(()=>[N("div",de,[e[9]||(e[9]=N("h2",null,"世界观设定",-1)),N("div",null,[l(d,{class:"mr-8",onClick:P},{default:a(()=>[l(w,null,{default:a(()=>[l(z(T))]),_:1}),e[7]||(e[7]=f(" AI 生成世界观 ",-1))]),_:1}),n.value?ue("",!0):(t(),c(d,{key:0,type:"primary",onClick:M},{default:a(()=>[l(w,null,{default:a(()=>[l(z(T))]),_:1}),e[8]||(e[8]=f(" 创建世界观 ",-1))]),_:1}))])])]),default:a(()=>[n.value?(t(),r("div",ce,[l(A,{model:o.value,ref_key:"formRef",ref:G,"label-width":"120px"},{default:a(()=>[l(y,{label:"时代背景"},{default:a(()=>[l(m,{modelValue:o.value.era,"onUpdate:modelValue":e[0]||(e[0]=u=>o.value.era=u),disabled:!p.value,placeholder:"请输入时代背景，如：现代、古代、未来等"},null,8,["modelValue","disabled"])]),_:1}),l(y,{label:"主要地点"},{default:a(()=>[l(b,{shadow:"never",class:"json-card"},{default:a(()=>[p.value?(t(),c(m,{key:1,modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=u=>h.value=u),type:"textarea",rows:4,placeholder:'JSON格式，如: {"主城": "繁华都市", "郊外": "宁静乡村"}'},null,8,["modelValue"])):(t(),r("div",ve,[o.value.locations&&Object.keys(o.value.locations).length?(t(),r("div",fe,[(t(!0),r(D,null,W(o.value.locations,(u,g)=>(t(),r("div",{key:g,class:"json-item"},[N("strong",null,J(g)+":",1),f(" "+J(u),1)]))),128))])):(t(),c(S,{key:1,description:"暂无地点设定","image-size":60}))]))]),_:1})]),_:1}),l(y,{label:"世界规则"},{default:a(()=>[l(b,{shadow:"never",class:"json-card"},{default:a(()=>[p.value?(t(),c(m,{key:1,modelValue:x.value,"onUpdate:modelValue":e[2]||(e[2]=u=>x.value=u),type:"textarea",rows:4,placeholder:'JSON格式，如: {"魔法体系": "元素魔法", "社会制度": "君主制"}'},null,8,["modelValue"])):(t(),r("div",pe,[o.value.rules&&Object.keys(o.value.rules).length?(t(),r("div",me,[(t(!0),r(D,null,W(o.value.rules,(u,g)=>(t(),r("div",{key:g,class:"json-item"},[N("strong",null,J(g)+":",1),f(" "+J(u),1)]))),128))])):(t(),c(S,{key:1,description:"暂无规则设定","image-size":60}))]))]),_:1})]),_:1}),l(y,{label:"文化设定"},{default:a(()=>[l(b,{shadow:"never",class:"json-card"},{default:a(()=>[p.value?(t(),c(m,{key:1,modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=u=>C.value=u),type:"textarea",rows:4,placeholder:'JSON格式，如: {"语言": "通用语", "宗教": "多神教"}'},null,8,["modelValue"])):(t(),r("div",_e,[o.value.culture&&Object.keys(o.value.culture).length?(t(),r("div",ye,[(t(!0),r(D,null,W(o.value.culture,(u,g)=>(t(),r("div",{key:g,class:"json-item"},[N("strong",null,J(g)+":",1),f(" "+J(u),1)]))),128))])):(t(),c(S,{key:1,description:"暂无文化设定","image-size":60}))]))]),_:1})]),_:1}),l(y,null,{default:a(()=>[p.value?(t(),r(D,{key:1},[l(d,{type:"primary",onClick:L,loading:_.value},{default:a(()=>[...e[11]||(e[11]=[f("保存",-1)])]),_:1},8,["loading"]),l(d,{onClick:H},{default:a(()=>[...e[12]||(e[12]=[f("取消",-1)])]),_:1})],64)):(t(),c(d,{key:0,type:"primary",onClick:q},{default:a(()=>[...e[10]||(e[10]=[f("编辑",-1)])]),_:1}))]),_:1})]),_:1},8,["model"])])):(t(),c(S,{key:1,description:"还没有创建世界观设定","image-size":100}))]),_:1})),[[Z,F.value]]),l(Y,{modelValue:j.value,"onUpdate:modelValue":e[6]||(e[6]=u=>j.value=u),title:"AI 生成世界观",width:"520px"},{footer:a(()=>[l(d,{onClick:e[5]||(e[5]=u=>j.value=!1)},{default:a(()=>[...e[13]||(e[13]=[f("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:K,loading:U.value},{default:a(()=>[...e[14]||(e[14]=[f("生成并应用",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(A,{model:I.value,"label-width":"100px"},{default:a(()=>[l(y,{label:"生成范围"},{default:a(()=>[l(X,{modelValue:I.value.focus,"onUpdate:modelValue":e[4]||(e[4]=u=>I.value.focus=u),style:{width:"100%"}},{default:a(()=>[l(k,{label:"整体",value:"overall"}),l(k,{label:"时代",value:"era"}),l(k,{label:"规则",value:"rules"}),l(k,{label:"地点",value:"locations"}),l(k,{label:"文化",value:"culture"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),be=re(ge,[["__scopeId","data-v-67419d99"]]);export{be as default};
