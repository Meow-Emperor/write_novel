import{d as Y,u as Z,J as ee,r as v,o as le,e as te,g as l,w as t,i,I as m,l as z,P as ae,Q as oe,C as ne,h as p,f as F,j as R,S as N,R as se,E as k,_ as re}from"./index-CtaRNcZl.js";import{a as ue}from"./aiParse-BPsoHwOo.js";const ie={class:"plot-structure"},de={class:"card-header"},pe=Y({__name:"PlotStructure",setup(ce){const q=Z(),C=ee().params.id,x=v(!1),U=v(!1),y=v(!1),V=v(!1),d=v([]),I=v(),b=v(!1),$=v(!1),c=v({plot_type:"main",plot_length:"medium",mode:"preview"}),n=v({title:"",description:"",act:"",key_events:"",characters:"",conflicts:""}),O={title:[{required:!0,message:"请输入情节标题",trigger:"blur"},{min:1,max:200,message:"标题长度为 1 到 200 个字符",trigger:"blur"}]};async function g(){x.value=!0;try{const a=await m.get("/api/plots",{params:{novel_id:C}});d.value=(a.data||[]).sort((e,u)=>(e.order??0)-(u.order??0))}catch(a){console.error("Failed to fetch plots:",a)}finally{x.value=!1}}function j(){V.value=!1,y.value=!0,n.value={title:"",description:"",act:"",key_events:"",characters:"",conflicts:""}}function G(a){V.value=!0,n.value={title:a.title,description:a.description,act:a.act||"",key_events:a.key_events||"",characters:a.characters||"",conflicts:a.conflicts||""},n.value.id=a.id,y.value=!0}async function J(a){try{await se.confirm("确定要删除这个情节吗？","提示",{type:"warning"}),await m.delete(`/api/plots/${a.id}`),k.success("删除成功"),g()}catch(e){e!=="cancel"&&console.error("Failed to delete plot:",e)}}async function Q(a){if(a===0)return;const e=d.value[a],u=d.value[a-1];try{await m.put(`/api/plots/${e.id}`,{order:u.order}),await m.put(`/api/plots/${u.id}`,{order:e.order}),g()}catch(s){console.error("Failed to move up:",s)}}async function T(a){if(a===d.value.length-1)return;const e=d.value[a],u=d.value[a+1];try{await m.put(`/api/plots/${e.id}`,{order:u.order}),await m.put(`/api/plots/${u.id}`,{order:e.order}),g()}catch(s){console.error("Failed to move down:",s)}}async function H(){I.value&&await I.value.validate(async a=>{if(a){U.value=!0;try{const e={...n.value};if(delete e.id,V.value&&n.value.id)await m.put(`/api/plots/${n.value.id}`,e),k.success("更新成功");else{const u=d.value.length>0?Math.max(...d.value.map(s=>s.order??0)):0;await m.post("/api/plots",{...e,novel_id:C,order:u+1}),k.success("创建成功")}y.value=!1,g()}catch(e){console.error("Submit failed:",e)}finally{U.value=!1}}})}function K(){c.value={plot_type:"main",plot_length:"medium",mode:"preview"},b.value=!0}async function L(){var a;try{$.value=!0;const e=q.config,s=((a=(await m.post("/api/ai/generate-plot",{novel_id:C,plot_type:c.value.plot_type,plot_length:c.value.plot_length,provider:e.provider,base_url:e.base_url,api_key:e.api_key,model_name:e.model_name,temperature:e.temperature})).data)==null?void 0:a.content)||"",r=ue(s);if(c.value.mode==="auto"){const A=d.value.length>0?Math.max(...d.value.map(S=>S.order??0)):0;await m.post("/api/plots",{novel_id:C,title:r.title,description:r.description,key_events:r.key_events,characters:r.characters,conflicts:r.conflicts,order:A+1}),k.success("AI 已生成并创建情节"),b.value=!1,g()}else V.value=!1,n.value={title:r.title||"AI 生成情节",description:r.description||s,act:"",key_events:r.key_events||"",characters:r.characters||"",conflicts:r.conflicts||""},b.value=!1,y.value=!0,k.success("AI 已生成内容，已填入表单供编辑")}catch{}finally{$.value=!1}}return le(()=>{g()}),(a,e)=>{const u=i("el-icon"),s=i("el-button"),r=i("el-table-column"),A=i("el-table"),S=i("el-card"),w=i("el-input"),f=i("el-form-item"),_=i("el-option"),D=i("el-select"),P=i("el-form"),B=i("el-dialog"),M=i("el-radio"),W=i("el-radio-group"),X=oe("loading");return z(),te("div",ie,[l(S,null,{header:t(()=>[F("div",de,[e[15]||(e[15]=F("h2",null,"情节架构",-1)),F("div",null,[l(s,{class:"mr-8",onClick:K},{default:t(()=>[l(u,null,{default:t(()=>[l(R(N))]),_:1}),e[13]||(e[13]=p(" AI 生成情节 ",-1))]),_:1}),l(s,{type:"primary",onClick:j},{default:t(()=>[l(u,null,{default:t(()=>[l(R(N))]),_:1}),e[14]||(e[14]=p(" 新建情节 ",-1))]),_:1})])])]),default:t(()=>[ae((z(),ne(A,{data:d.value,stripe:""},{default:t(()=>[l(r,{prop:"order",label:"顺序",width:"80"}),l(r,{prop:"title",label:"情节标题",width:"220"}),l(r,{prop:"description",label:"情节描述","show-overflow-tooltip":""}),l(r,{prop:"act",label:"幕次",width:"100"}),l(r,{label:"操作",width:"320",fixed:"right"},{default:t(({row:o,$index:h})=>[l(s,{size:"small",onClick:E=>G(o)},{default:t(()=>[...e[16]||(e[16]=[p("编辑",-1)])]),_:1},8,["onClick"]),l(s,{size:"small",onClick:E=>Q(h),disabled:h===0},{default:t(()=>[...e[17]||(e[17]=[p("上移",-1)])]),_:1},8,["onClick","disabled"]),l(s,{size:"small",onClick:E=>T(h),disabled:h===d.value.length-1},{default:t(()=>[...e[18]||(e[18]=[p("下移",-1)])]),_:1},8,["onClick","disabled"]),l(s,{size:"small",type:"danger",onClick:E=>J(o)},{default:t(()=>[...e[19]||(e[19]=[p("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[X,x.value]])]),_:1}),l(B,{modelValue:y.value,"onUpdate:modelValue":e[7]||(e[7]=o=>y.value=o),title:V.value?"编辑情节":"新建情节",width:"720px",onClose:a.resetForm},{footer:t(()=>[l(s,{onClick:e[6]||(e[6]=o=>y.value=!1)},{default:t(()=>[...e[20]||(e[20]=[p("取消",-1)])]),_:1}),l(s,{type:"primary",onClick:H,loading:U.value},{default:t(()=>[...e[21]||(e[21]=[p("确定",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(P,{model:n.value,rules:O,ref_key:"formRef",ref:I,"label-width":"100px"},{default:t(()=>[l(f,{label:"情节标题",prop:"title"},{default:t(()=>[l(w,{modelValue:n.value.title,"onUpdate:modelValue":e[0]||(e[0]=o=>n.value.title=o),placeholder:"请输入情节标题"},null,8,["modelValue"])]),_:1}),l(f,{label:"情节描述",prop:"description"},{default:t(()=>[l(w,{modelValue:n.value.description,"onUpdate:modelValue":e[1]||(e[1]=o=>n.value.description=o),type:"textarea",rows:4,placeholder:"请输入情节描述"},null,8,["modelValue"])]),_:1}),l(f,{label:"幕次",prop:"act"},{default:t(()=>[l(D,{modelValue:n.value.act,"onUpdate:modelValue":e[2]||(e[2]=o=>n.value.act=o),placeholder:"请选择幕次",clearable:"",style:{width:"100%"}},{default:t(()=>[l(_,{label:"第一幕",value:"第一幕"}),l(_,{label:"第二幕",value:"第二幕"}),l(_,{label:"第三幕",value:"第三幕"})]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"关键事件",prop:"key_events"},{default:t(()=>[l(w,{modelValue:n.value.key_events,"onUpdate:modelValue":e[3]||(e[3]=o=>n.value.key_events=o),type:"textarea",rows:3,placeholder:"请输入关键事件（可分行）"},null,8,["modelValue"])]),_:1}),l(f,{label:"相关角色",prop:"characters"},{default:t(()=>[l(w,{modelValue:n.value.characters,"onUpdate:modelValue":e[4]||(e[4]=o=>n.value.characters=o),type:"textarea",rows:2,placeholder:"请输入相关角色（可分行）"},null,8,["modelValue"])]),_:1}),l(f,{label:"冲突/转折",prop:"conflicts"},{default:t(()=>[l(w,{modelValue:n.value.conflicts,"onUpdate:modelValue":e[5]||(e[5]=o=>n.value.conflicts=o),type:"textarea",rows:3,placeholder:"请输入冲突与转折"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title","onClose"]),l(B,{modelValue:b.value,"onUpdate:modelValue":e[12]||(e[12]=o=>b.value=o),title:"AI 生成情节",width:"520px"},{footer:t(()=>[l(s,{onClick:e[11]||(e[11]=o=>b.value=!1)},{default:t(()=>[...e[24]||(e[24]=[p("取消",-1)])]),_:1}),l(s,{type:"primary",onClick:L,loading:$.value},{default:t(()=>[...e[25]||(e[25]=[p("生成",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(P,{model:c.value,"label-width":"100px"},{default:t(()=>[l(f,{label:"情节类型"},{default:t(()=>[l(D,{modelValue:c.value.plot_type,"onUpdate:modelValue":e[8]||(e[8]=o=>c.value.plot_type=o),style:{width:"100%"}},{default:t(()=>[l(_,{label:"主线",value:"main"}),l(_,{label:"支线",value:"subplot"}),l(_,{label:"反转",value:"twist"})]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"长度"},{default:t(()=>[l(D,{modelValue:c.value.plot_length,"onUpdate:modelValue":e[9]||(e[9]=o=>c.value.plot_length=o),style:{width:"100%"}},{default:t(()=>[l(_,{label:"简短",value:"short"}),l(_,{label:"适中",value:"medium"}),l(_,{label:"详细",value:"long"})]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"保存方式"},{default:t(()=>[l(W,{modelValue:c.value.mode,"onUpdate:modelValue":e[10]||(e[10]=o=>c.value.mode=o)},{default:t(()=>[l(M,{label:"preview"},{default:t(()=>[...e[22]||(e[22]=[p("预览并编辑",-1)])]),_:1}),l(M,{label:"auto"},{default:t(()=>[...e[23]||(e[23]=[p("直接创建",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),_e=re(pe,[["__scopeId","data-v-671b0965"]]);export{_e as default};
